<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>è‰²å½©å®éªŒå®¤</title>
    <style>
        :root {
            --bg-color: #2C3E50;
            --tube-border: rgba(255, 255, 255, 0.4);
            --tube-bg: rgba(255, 255, 255, 0.05);
            --liquid-red: #E74C3C;
            --liquid-blue: #3498DB;
            --liquid-green: #2ECC71;
            --liquid-yellow: #F1C40F;
            --liquid-purple: #9B59B6;
            --liquid-orange: #E67E22;
            --liquid-cyan: #1ABC9C;
        }

        body {
            margin: 0;
            background-color: var(--bg-color);
            color: white;
            font-family: 'Segoe UI', sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            height: 100vh;
            overflow: hidden;
            touch-action: none;
            user-select: none;
        }

        /* é¡¶éƒ¨ UI */
        .header {
            margin-top: 20px;
            display: flex;
            justify-content: space-between;
            width: 90%;
            max-width: 500px;
            align-items: center;
        }
        
        .level-badge {
            background: rgba(0,0,0,0.3);
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 1.2rem;
        }

        .btn-reset {
            background: none;
            border: 2px solid rgba(255,255,255,0.5);
            color: white;
            width: 40px; height: 40px;
            border-radius: 50%;
            font-size: 1.2rem;
            cursor: pointer;
            display: flex; justify-content: center; align-items: center;
        }
        .btn-reset:active { background: rgba(255,255,255,0.2); transform: rotate(-180deg); transition: 0.3s; }

        /* æ¸¸æˆåŒºåŸŸ */
        .game-board {
            flex: 1;
            width: 100%;
            max-width: 500px;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            align-content: center;
            gap: 20px; /* è¯•ç®¡é—´è· */
            padding: 20px;
            box-sizing: border-box;
        }

        /* è¯•ç®¡æ ·å¼ */
        .tube {
            width: 60px;
            height: 220px;
            border: 4px solid var(--tube-border);
            border-top: none; /* è¯•ç®¡å£æ²¡è¾¹æ¡† */
            border-radius: 0 0 25px 25px;
            background: var(--tube-bg);
            position: relative;
            cursor: pointer;
            transition: transform 0.2s, border-color 0.2s;
            display: flex;
            flex-direction: column-reverse; /* æ¶²ä½“ä»åº•éƒ¨å †ç§¯ */
            overflow: hidden;
            /* è¯•ç®¡å£è£…é¥° */
            box-shadow: inset 0 -5px 10px rgba(0,0,0,0.2);
        }
        
        /* è¯•ç®¡é€‰ä¸­çŠ¶æ€ */
        .tube.selected {
            transform: translateY(-25px);
            border-color: rgba(255,255,255,0.9);
            box-shadow: 0 10px 20px rgba(0,0,0,0.3);
        }

        /* æ¶²ä½“å— */
        .liquid {
            width: 100%;
            height: 25%; /* æ¯ä¸ªæ¶²ä½“å 1/4é«˜åº¦ */
            transition: height 0.2s;
            position: relative;
        }
        /* æ¶²ä½“é¡¶éƒ¨åœ†è§’ï¼ˆå¦‚æœæ˜¯æœ€ä¸Šé¢çš„æ¶²ä½“ï¼‰ */
        .liquid:last-child {
            border-radius: 5px 5px 0 0;
        }
        /* æ¶²ä½“åº•éƒ¨åœ†è§’ï¼ˆå¦‚æœæ˜¯æœ€ä¸‹é¢çš„æ¶²ä½“ï¼‰ */
        .tube .liquid:first-child {
            border-radius: 0 0 20px 20px;
        }
        
        /* æ¶²ä½“åŠ¨ç”» */
        @keyframes pour {
            0% { height: 0; opacity: 0; }
            100% { height: 25%; opacity: 1; }
        }
        .liquid.adding {
            animation: pour 0.2s forwards;
        }

        /* èƒœåˆ©å¼¹çª— */
        .modal {
            position: absolute; top:0; left:0; width:100%; height:100%;
            background: rgba(0,0,0,0.8);
            display: none;
            flex-direction: column;
            justify-content: center; align-items: center;
            z-index: 10;
            backdrop-filter: blur(5px);
        }
        .modal-content {
            background: white; color: #333;
            padding: 40px; border-radius: 20px; text-align: center;
            animation: pop 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .btn-next {
            background: #2ECC71; color: white; border: none;
            padding: 15px 40px; font-size: 1.2rem; border-radius: 30px;
            margin-top: 20px; cursor: pointer; font-weight: bold;
            box-shadow: 0 5px 0 #27ae60;
        }
        .btn-next:active { transform: translateY(5px); box-shadow: none; }

        @keyframes pop { from {transform: scale(0.8); opacity:0;} to {transform: scale(1); opacity:1;}}

    </style>
</head>
<body>

    <div class="header">
        <div class="level-badge">LEVEL <span id="level-display">1</span></div>
        <button class="btn-reset" onclick="Game.restartLevel()">â†º</button>
    </div>

    <div class="game-board" id="board">
        </div>

    <div class="modal" id="win-modal">
        <div class="modal-content">
            <h1 style="margin:0 0 10px 0; font-size:3rem;">ğŸ§ª</h1>
            <h2 style="margin:0;">é…æ–¹æ­£ç¡®ï¼</h2>
            <p>å¤§è„‘é€»è¾‘ +1</p>
            <button class="btn-next" onclick="Game.nextLevel()">ä¸‹ä¸€å…³</button>
        </div>
    </div>

    <script>
        // --- ğŸ”Š å£°éŸ³å¼•æ“ (Web Audio API) ---
        const AudioSys = {
            ctx: new (window.AudioContext || window.webkitAudioContext)(),
            playTone(freq, type='sine', duration=0.1) {
                if(this.ctx.state === 'suspended') this.ctx.resume();
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                osc.type = type;
                osc.frequency.setValueAtTime(freq, this.ctx.currentTime);
                gain.gain.setValueAtTime(0.1, this.ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + duration);
                osc.connect(gain);
                gain.connect(this.ctx.destination);
                osc.start();
                osc.stop(this.ctx.currentTime + duration);
            },
            playSelect() {
                // ç»ç’ƒæ•²å‡»å£° (é«˜é¢‘æ­£å¼¦æ³¢)
                this.playTone(800, 'sine', 0.1);
            },
            playPour() {
                // å€’æ°´å£° (æ¨¡æ‹Ÿæ°”æ³¡æ„Ÿ)
                this.playTone(300, 'triangle', 0.15);
                setTimeout(() => this.playTone(250, 'triangle', 0.15), 50);
            },
            playWin() {
                // èƒœåˆ©å’Œå¼¦
                [523.25, 659.25, 783.99, 1046.50].forEach((f, i) => {
                    setTimeout(() => this.playTone(f, 'sine', 0.4), i * 100);
                });
            }
        };

        // --- ğŸ¨ é¢œè‰²é…ç½® ---
        const COLORS = [
            '#E74C3C', // Red
            '#3498DB', // Blue
            '#F1C40F', // Yellow
            '#2ECC71', // Green
            '#9B59B6', // Purple
            '#E67E22', // Orange
            '#1ABC9C', // Cyan
            '#34495E'  // Dark Blue
        ];

        // --- ğŸ® æ¸¸æˆé€»è¾‘ ---
        const Game = {
            level: 1,
            tubes: [], // æ•°æ®ç»“æ„: [['red', 'blue'], [], ['red']]
            tubeCapacity: 4,
            selectedTubeIndex: null,
            isAnimating: false,
            initialState: [], // ç”¨äºé‡ç½®

            init() {
                this.startLevel(1);
            },

            startLevel(lvl) {
                this.level = lvl;
                document.getElementById('level-display').innerText = lvl;
                document.getElementById('win-modal').style.display = 'none';
                
                // éš¾åº¦ç”Ÿæˆç®—æ³•
                // çº§åˆ«è¶Šé«˜ï¼Œé¢œè‰²è¶Šå¤šï¼Œç©ºç®¡è¶Šå°‘
                let numColors = 2 + Math.floor((lvl - 1) / 2); // æ¯2å…³åŠ ä¸€ç§é¢œè‰²
                if(numColors > COLORS.length) numColors = COLORS.length;
                
                let numTubes = numColors + 2; // æ€»æ˜¯å¤š2ä¸ªç©ºç®¡
                
                // 1. å…ˆç”Ÿæˆå®ŒæˆçŠ¶æ€ (æ»¡ç®¡é¢œè‰²)
                let solvedState = [];
                for(let i=0; i<numColors; i++) {
                    let tube = [];
                    for(let j=0; j<this.tubeCapacity; j++) {
                        tube.push(i); // å­˜å‚¨é¢œè‰²çš„ç´¢å¼•
                    }
                    solvedState.push(tube);
                }
                // æ·»åŠ ç©ºç®¡
                solvedState.push([], []);

                // 2. éšæœºæ‰“ä¹± (å€’ç€ç©)
                // æ¨¡æ‹Ÿä»ä¸€ä¸ªåˆæ³•çš„çŠ¶æ€å€’äº† N æ¬¡æ°´ï¼Œè¿™æ ·ä¿è¯ä¸€å®šæœ‰è§£
                this.tubes = this.shuffle(solvedState, lvl * 15); 
                
                // æ·±æ‹·è´ä¿å­˜åˆå§‹çŠ¶æ€ç”¨äºé‡ç½®
                this.initialState = JSON.parse(JSON.stringify(this.tubes));
                
                this.render();
            },

            shuffle(state, moves) {
                // è¿™æ˜¯ä¸€ä¸ªæ¨¡æ‹Ÿæ‰“ä¹±è¿‡ç¨‹ï¼Œæ¨¡æ‹Ÿåˆæ³•çš„å€’æ°´æ“ä½œ
                // ä¸ºäº†ç®€å•èµ·è§ï¼Œè¿™é‡Œä½¿ç”¨ä¸€ç§ç®€å•çš„éšæœºåˆ†é…ç®—æ³•ï¼Œ
                // åªè¦ä¿è¯æ€»é¢œè‰²æ•°é‡å®ˆæ’å³å¯ (è™½ç„¶æå°æ¦‚ç‡æ— è§£ï¼Œä½†é€šå¸¸å¯è§£)
                // æ›´ä¸¥è°¨çš„åšæ³•æ˜¯å†™ä¸€ä¸ªæ±‚è§£å™¨åæ¨ï¼Œä½†ä»£ç é‡å¤ªå¤§ã€‚
                // è¿™é‡Œé‡‡ç”¨ï¼šå°†æ‰€æœ‰æ¶²ä½“å€’å‡ºæ¥ï¼Œéšæœºå¡«å›ï¼Œé™¤äº†æœ€åä¸¤ä¸ªç©ºç®¡ã€‚
                
                let allLiquids = [];
                state.forEach(tube => {
                    tube.forEach(color => allLiquids.push(color));
                    tube.length = 0; // æ¸…ç©º
                });

                // éšæœºæ‰“ä¹±æ¶²ä½“æ•°ç»„
                allLiquids.sort(() => Math.random() - 0.5);

                // å¡«å›å‰ N-2 ä¸ªç®¡å­
                let tubeIndex = 0;
                while(allLiquids.length > 0) {
                    if (state[tubeIndex].length < 4) {
                        state[tubeIndex].push(allLiquids.pop());
                    } else {
                        tubeIndex++;
                        if(tubeIndex >= state.length - 2) tubeIndex = 0; // åªæ˜¯ä¸ºäº†é˜²æ­¢æº¢å‡ºé€»è¾‘é”™è¯¯ï¼Œå®é™…ä¸Šå®¹é‡æ˜¯å¤Ÿçš„
                    }
                }
                return state;
            },

            render() {
                const board = document.getElementById('board');
                board.innerHTML = '';

                this.tubes.forEach((tubeData, index) => {
                    const tubeEl = document.createElement('div');
                    tubeEl.className = `tube ${this.selectedTubeIndex === index ? 'selected' : ''}`;
                    tubeEl.onclick = () => this.handleTubeClick(index);

                    // æ¸²æŸ“æ¶²ä½“
                    tubeData.forEach(colorIndex => {
                        const liquid = document.createElement('div');
                        liquid.className = 'liquid';
                        liquid.style.backgroundColor = COLORS[colorIndex];
                        tubeEl.appendChild(liquid);
                    });

                    board.appendChild(tubeEl);
                });
            },

            handleTubeClick(index) {
                if (this.isAnimating) return;

                // 1. å¦‚æœæ²¡é€‰ä¸­ï¼Œä¸”ç‚¹å‡»çš„ä¸æ˜¯ç©ºç®¡ -> é€‰ä¸­
                if (this.selectedTubeIndex === null) {
                    if (this.tubes[index].length > 0) {
                        this.selectedTubeIndex = index;
                        AudioSys.playSelect();
                        this.render();
                    }
                    return;
                }

                // 2. å¦‚æœç‚¹å‡»çš„æ˜¯å·²é€‰ä¸­çš„ -> å–æ¶ˆé€‰ä¸­
                if (this.selectedTubeIndex === index) {
                    this.selectedTubeIndex = null;
                    AudioSys.playSelect();
                    this.render();
                    return;
                }

                // 3. å°è¯•å€’æ°´
                this.tryPour(this.selectedTubeIndex, index);
            },

            tryPour(fromIdx, toIdx) {
                const fromTube = this.tubes[fromIdx];
                const toTube = this.tubes[toIdx];

                const colorToMove = fromTube[fromTube.length - 1]; // æºç®¡æœ€ä¸Šé¢çš„é¢œè‰²
                const targetColor = toTube.length > 0 ? toTube[toTube.length - 1] : null; // ç›®æ ‡ç®¡æœ€ä¸Šé¢çš„é¢œè‰²

                // è§„åˆ™åˆ¤å®šï¼š
                // 1. ç›®æ ‡ç®¡æœªæ»¡
                // 2. ç›®æ ‡ç®¡æ˜¯ç©ºçš„ OR ç›®æ ‡ç®¡é¡¶éƒ¨é¢œè‰² == è¦å€’çš„é¢œè‰²
                if (toTube.length < this.tubeCapacity && (toTube.length === 0 || targetColor === colorToMove)) {
                    
                    // æ‰§è¡Œç§»åŠ¨
                    // å¯èƒ½æœ‰å¤šæ ¼ç›¸åŒé¢œè‰²ï¼Œä¸€æ¬¡æ€§å€’è¿‡å»ï¼Ÿé€šå¸¸æ¸¸æˆè®¾å®šæ˜¯ä¸€æ ¼æ ¼å€’ï¼Œæˆ–è€…ä¸€æ¬¡å€’å®Œè¿ç»­çš„åŒè‰²
                    // ä¸ºäº†è§†è§‰æ•ˆæœå’Œç®€åŒ–ï¼Œæˆ‘ä»¬è¿™é‡Œå®ç°ï¼šä¸€æ¬¡å€’ä¸€æ ¼ (ç»å…¸æ¨¡å¼)
                    // å¦‚æœä½ æƒ³ä¸€æ¬¡å€’å®Œæ‰€æœ‰è¿ç»­åŒè‰²ï¼Œå¯ä»¥åœ¨è¿™é‡ŒåŠ ä¸ªå¾ªç¯
                    
                    // è¿å€’é€»è¾‘ (ä¸€æ¬¡å€’å®Œé¡¶å±‚æ‰€æœ‰ç›¸åŒé¢œè‰²ï¼Œåªè¦å¯¹é¢è£…å¾—ä¸‹)
                    let movedCount = 0;
                    while (
                        fromTube.length > 0 && 
                        fromTube[fromTube.length - 1] === colorToMove &&
                        toTube.length < this.tubeCapacity
                    ) {
                        toTube.push(fromTube.pop());
                        movedCount++;
                    }

                    AudioSys.playPour();
                    this.selectedTubeIndex = null;
                    this.render();

                    // æ·»åŠ åŠ¨ç”»ç±» (ç¨å¾®hackä¸€ç‚¹ï¼Œé‡æ–°è·å–DOM)
                    const tubesDom = document.querySelectorAll('.tube');
                    const toTubeLiquids = tubesDom[toIdx].querySelectorAll('.liquid');
                    // ç»™æ–°åŠ çš„æ¶²ä½“æ·»åŠ åŠ¨ç”»class
                    for(let i=0; i<movedCount; i++) {
                        let el = toTubeLiquids[toTubeLiquids.length - 1 - i];
                        if(el) el.classList.add('adding');
                    }

                    this.checkWin();

                } else {
                    // æ— æ•ˆæ“ä½œ
                    // æŠ–åŠ¨ä¸€ä¸‹è¡¨ç¤ºä¸è¡Œ (æš‚ç•¥)
                    this.selectedTubeIndex = null;
                    this.render();
                }
            },

            checkWin() {
                // èƒœåˆ©æ¡ä»¶ï¼šæ‰€æœ‰ç®¡å­è¦ä¹ˆæ˜¯ç©ºçš„ï¼Œè¦ä¹ˆæ˜¯æ»¡çš„ä¸”å…¨æ˜¯ä¸€ç§é¢œè‰²
                const isWin = this.tubes.every(tube => {
                    if (tube.length === 0) return true; // ç©ºç®¡ ok
                    if (tube.length !== this.tubeCapacity) return false; // æ²¡æ»¡ no
                    // æ£€æŸ¥é¢œè‰²æ˜¯å¦å…¨ä¸€æ ·
                    const firstColor = tube[0];
                    return tube.every(c => c === firstColor);
                });

                if (isWin) {
                    setTimeout(() => {
                        AudioSys.playWin();
                        document.getElementById('win-modal').style.display = 'flex';
                        // ç¤¼èŠ±ç‰¹æ•ˆ (ç®€å•å¤ç”¨ä¸Šä¸ªæ¸¸æˆçš„é€»è¾‘æ€è·¯ï¼Œè¿™é‡Œçœç•¥å…·ä½“å®ç°ï¼Œç”¨Emojiä»£æ›¿)
                    }, 300);
                }
            },

            nextLevel() {
                this.startLevel(this.level + 1);
            },

            restartLevel() {
                this.tubes = JSON.parse(JSON.stringify(this.initialState));
                this.selectedTubeIndex = null;
                this.render();
            }
        };

        // å¯åŠ¨
        Game.init();

    </script>
</body>
</html>