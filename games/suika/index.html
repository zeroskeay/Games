<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>åˆæˆå¤§è¥¿ç“œ</title>
    <style>
        :root {
            --bg-color: #FFE8D6;
            --wall-color: #CB997E;
            --score-color: #6B705C;
        }

        body {
            margin: 0;
            overflow: hidden;
            background-color: var(--bg-color);
            font-family: "Segoe UI", sans-serif;
            touch-action: none; /* ç¦æ­¢æµè§ˆå™¨é»˜è®¤ç¼©æ”¾æ»šåŠ¨ */
            user-select: none;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
        }

        #game-container {
            position: relative;
            width: 100%;
            max-width: 450px; /* é™åˆ¶æœ€å¤§å®½åº¦ï¼Œæ¨¡æ‹Ÿæ‰‹æœºå± */
            height: 100%;
            background: #FFF1E6;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        canvas {
            display: block;
            width: 100%;
            height: 100%;
        }

        /* UI å±‚ */
        #ui-layer {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none;
        }

        .header {
            position: absolute;
            top: 20px; left: 20px;
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--score-color);
            display: flex;
            flex-direction: column;
        }
        
        .next-fruit {
            margin-top: 10px;
            font-size: 0.9rem;
            color: #A5A58D;
        }

        #game-over-modal {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7);
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            pointer-events: auto;
            backdrop-filter: blur(5px);
            z-index: 100;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 20px;
            text-align: center;
            animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        h2 { margin: 0 0 10px 0; color: #E76F51; }
        p { font-size: 1.2rem; color: #555; margin-bottom: 20px; }

        .btn {
            background: #E76F51; color: white; border: none;
            padding: 12px 30px; border-radius: 50px; font-size: 1rem;
            cursor: pointer; font-weight: bold;
            box-shadow: 0 4px 10px rgba(231, 111, 81, 0.3);
        }
        .btn:active { transform: scale(0.95); }

        /* è­¦æˆ’çº¿ */
        #danger-line {
            position: absolute;
            top: 150px; /* è·ç¦»é¡¶éƒ¨ */
            left: 0; width: 100%; height: 2px;
            border-top: 2px dashed #E76F51;
            opacity: 0;
            transition: opacity 0.5s;
        }
        #danger-line::after {
            content: 'âš ï¸ è­¦æˆ’çº¿';
            position: absolute; right: 10px; top: -20px;
            color: #E76F51; font-size: 0.8rem;
        }

        @keyframes popIn { from {transform: scale(0.8); opacity: 0;} to {transform: scale(1); opacity: 1;} }
    </style>
</head>
<body>

    <div id="game-container">
        <canvas id="gameCanvas"></canvas>
        <div id="danger-line"></div>

        <div id="ui-layer">
            <div class="header">
                <div>å¾—åˆ†: <span id="score-val">0</span></div>
                <div class="next-fruit">ä¸‹ä¸€ä¸ª: <span id="next-fruit-icon">ğŸ‡</span></div>
            </div>
        </div>

        <div id="game-over-modal">
            <div class="modal-content">
                <h2>ğŸ’¥ æº¢å‡ºäº†ï¼</h2>
                <p>æœ€ç»ˆå¾—åˆ†: <span id="final-score">0</span></p>
                <button class="btn" onclick="Game.reset()">å†è¯•ä¸€æ¬¡</button>
            </div>
        </div>
    </div>

    <script>
        // --- ğŸ”§ ç®€æ˜“ç‰©ç†å¼•æ“ä¸æ¸¸æˆé…ç½® ---
        const CONFIG = {
            gravity: 0.5,       // é‡åŠ›
            friction: 0.98,     // ç©ºæ°”/åœ°é¢æ‘©æ“¦
            bounce: 0.4,        // å¼¹æ€§ (è¶Šå°è¶Šä¸å®¹æ˜“ä¹±å¼¹)
            spawnY: 50,         // ç”Ÿæˆé«˜åº¦
            dangerY: 150,       // å¤±è´¥åˆ¤å®šçº¿
            clickCooldown: 500  // ç‚¹å‡»å†·å´(ms)
        };

        // æ°´æœç­‰çº§å®šä¹‰
        // åŠå¾„ä¼šæ ¹æ®å±å¹•å®½åº¦è‡ªé€‚åº”ç¼©æ”¾
        const FRUITS = [
            { id: 0, icon: 'ğŸ‡', color: '#9D4EDD', radius: 20, score: 2 },
            { id: 1, icon: 'ğŸ’', color: '#D00000', radius: 30, score: 4 },
            { id: 2, icon: 'ğŸŠ', color: '#FFBA08', radius: 42, score: 8 },
            { id: 3, icon: 'ğŸ‹', color: '#FFEE32', radius: 50, score: 16 },
            { id: 4, icon: 'ğŸ¥', color: '#70E000', radius: 62, score: 32 },
            { id: 5, icon: 'ğŸ…', color: '#FF6347', radius: 75, score: 64 },
            { id: 6, icon: 'ğŸ‘', color: '#FFADAD', radius: 88, score: 128 },
            { id: 7, icon: 'ğŸ', color: '#FFD60A', radius: 100, score: 256 },
            { id: 8, icon: 'ğŸ¥¥', color: '#CB997E', radius: 115, score: 512 },
            { id: 9, icon: 'ğŸ‰', color: '#52B788', radius: 135, score: 1024 },
        ];

        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        let WIDTH, HEIGHT, SCALE;

        // --- ğŸŸ¢ ç‰©ç†çƒä½“ç±» ---
        class Ball {
            constructor(x, y, level) {
                this.x = x;
                this.y = y;
                this.level = level;
                this.vx = 0; // é€Ÿåº¦X
                this.vy = 0; // é€Ÿåº¦Y
                this.radius = FRUITS[level].radius * SCALE;
                this.mass = this.radius; // è´¨é‡ä¸åŠå¾„æˆæ­£æ¯”
                this.dead = false;
                this.growing = 0; // åˆšç”Ÿæˆæ—¶çš„è†¨èƒ€åŠ¨ç”» 0 -> 1
                this.mergeTimer = 0; // é˜²æ­¢è¿ç»­åˆå¹¶çš„å†·å´
            }

            update() {
                // åŠ¨ç”»
                if (this.growing < 1) this.growing += 0.1;

                // 1. é‡åŠ›
                this.vy += CONFIG.gravity;

                // 2. åº”ç”¨é€Ÿåº¦
                this.x += this.vx;
                this.y += this.vy;

                // 3. æ‘©æ“¦åŠ› (ç®€å•çš„é˜»å°¼)
                this.vx *= CONFIG.friction;
                this.vy *= CONFIG.friction;

                // 4. å¢™å£ç¢°æ’
                // å·¦
                if (this.x < this.radius) {
                    this.x = this.radius;
                    this.vx *= -CONFIG.bounce;
                }
                // å³
                if (this.x > WIDTH - this.radius) {
                    this.x = WIDTH - this.radius;
                    this.vx *= -CONFIG.bounce;
                }
                // åœ°é¢
                if (this.y > HEIGHT - this.radius) {
                    this.y = HEIGHT - this.radius;
                    this.vy *= -CONFIG.bounce; // å¼¹æ€§æŸè€—
                    // å¦‚æœé€Ÿåº¦å¾ˆå°ï¼Œç›´æ¥åœæ­¢ï¼Œé˜²æ­¢æŠ–åŠ¨
                    if (Math.abs(this.vy) < CONFIG.gravity * 2) this.vy = 0;
                }
            }

            draw() {
                const r = this.radius * (this.growing > 1 ? 1 : this.growing);
                const fruit = FRUITS[this.level];
                
                ctx.save();
                ctx.translate(this.x, this.y);
                // æ—‹è½¬ (æ ¹æ®Xé€Ÿåº¦ç®€å•æ¨¡æ‹Ÿæ—‹è½¬)
                // è¿™é‡Œçš„æ—‹è½¬æ˜¯è§†è§‰ä¸Šçš„ï¼Œä¸ºäº†ç®€åŒ–è®¡ç®—ä¸å­˜å‚¨å®é™…è§’é€Ÿåº¦
                const rotation = this.x * 0.05; 
                ctx.rotate(rotation);

                // ç”»åœ†èƒŒæ™¯
                ctx.beginPath();
                ctx.arc(0, 0, r, 0, Math.PI * 2);
                ctx.fillStyle = fruit.color;
                ctx.fill();
                
                // ç”»é«˜å…‰ (è®©çƒçœ‹èµ·æ¥ç«‹ä½“)
                ctx.beginPath();
                ctx.arc(-r*0.3, -r*0.3, r*0.2, 0, Math.PI*2);
                ctx.fillStyle = 'rgba(255,255,255,0.3)';
                ctx.fill();

                // ç”»è¾¹æ¡†
                ctx.lineWidth = 3;
                ctx.strokeStyle = 'rgba(0,0,0,0.1)';
                ctx.stroke();

                // ç”»Emoji
                ctx.font = `${r}px Arial`;
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(fruit.icon, 0, 5 * SCALE); // å¾®è°ƒå‚ç›´ä½ç½®

                ctx.restore();
            }
        }

        // --- ğŸ® æ¸¸æˆä¸»é€»è¾‘ ---
        const Game = {
            balls: [],
            score: 0,
            state: 'ready', // ready, playing, gameover
            nextFruitLevel: 0,
            activeBall: null, // é¡¶éƒ¨è·Ÿéšæ‰‹æŒ‡çš„çƒ
            lastClickTime: 0,
            particles: [], // çˆ†ç‚¸ç‰¹æ•ˆç²’å­

            init() {
                this.resize();
                window.addEventListener('resize', () => this.resize());
                
                // è¾“å…¥äº‹ä»¶
                const container = document.getElementById('game-container');
                container.addEventListener('mousemove', e => this.handleMove(e.clientX));
                container.addEventListener('touchmove', e => {
                    e.preventDefault();
                    this.handleMove(e.touches[0].clientX);
                }, {passive: false});
                
                container.addEventListener('mouseup', () => this.handleClick());
                container.addEventListener('touchend', (e) => {
                    e.preventDefault();
                    this.handleClick();
                });

                this.reset();
                this.loop();
            },

            resize() {
                const container = document.getElementById('game-container');
                WIDTH = container.clientWidth;
                HEIGHT = container.clientHeight;
                canvas.width = WIDTH;
                canvas.height = HEIGHT;
                // åŸºäºå®½åº¦çš„ç¼©æ”¾æ¯”ä¾‹ï¼Œä»¥é€‚é…æ‰‹æœº
                SCALE = WIDTH / 450; 
            },

            reset() {
                this.balls = [];
                this.particles = [];
                this.score = 0;
                this.state = 'playing';
                this.nextFruitLevel = 0;
                document.getElementById('score-val').innerText = 0;
                document.getElementById('game-over-modal').style.display = 'none';
                document.getElementById('danger-line').style.opacity = 0;
                this.spawnActiveBall();
            },

            spawnActiveBall() {
                // ç”Ÿæˆé¡¶éƒ¨å¾…å‘½çš„çƒ
                this.activeBall = {
                    x: WIDTH / 2,
                    y: CONFIG.spawnY,
                    level: this.nextFruitLevel
                };
                // éšæœºä¸‹ä¸€ä¸ª (é™åˆ¶åœ¨å‰5ä¸ªå°çš„ï¼Œé˜²æ­¢ç›´æ¥ç”Ÿæˆå¤§è¥¿ç“œ)
                this.nextFruitLevel = Math.floor(Math.random() * 4); 
                document.getElementById('next-fruit-icon').innerText = FRUITS[this.nextFruitLevel].icon;
            },

            handleMove(clientX) {
                if (this.state !== 'playing' || !this.activeBall) return;
                
                // è®¡ç®—ç›¸å¯¹äºcanvasçš„Xåæ ‡
                const rect = canvas.getBoundingClientRect();
                let x = clientX - rect.left;
                
                // é™åˆ¶è¾¹ç•Œï¼Œä¸è®©çƒçš„ä¸€åŠå‡ºå±å¹•
                const r = FRUITS[this.activeBall.level].radius * SCALE;
                if (x < r) x = r;
                if (x > WIDTH - r) x = WIDTH - r;

                this.activeBall.x = x;
            },

            handleClick() {
                const now = Date.now();
                if (this.state !== 'playing' || !this.activeBall || now - this.lastClickTime < CONFIG.clickCooldown) return;

                this.lastClickTime = now;

                // 1. å°†activeBallå˜æˆå®ä½“çƒ
                const ball = new Ball(this.activeBall.x, this.activeBall.y, this.activeBall.level);
                this.balls.push(ball);
                this.activeBall = null;

                // 2. å»¶è¿Ÿç”Ÿæˆä¸‹ä¸€ä¸ªï¼Œé˜²æ­¢è¿ç‚¹
                setTimeout(() => {
                    if (this.state === 'playing') this.spawnActiveBall();
                }, 500);
            },

            checkCollisions() {
                for (let i = 0; i < this.balls.length; i++) {
                    for (let j = i + 1; j < this.balls.length; j++) {
                        const b1 = this.balls[i];
                        const b2 = this.balls[j];
                        if (b1.dead || b2.dead) continue;

                        const dx = b2.x - b1.x;
                        const dy = b2.y - b1.y;
                        const dist = Math.sqrt(dx * dx + dy * dy);
                        const minDist = b1.radius + b2.radius;

                        if (dist < minDist) {
                            // --- ç¢°æ’å¤„ç† ---
                            
                            // 1. æ±‚è§£é‡å ï¼Œæ¨å¼€ä¸¤ä¸ªçƒ (ä½ç½®ä¿®æ­£)
                            const angle = Math.atan2(dy, dx);
                            const tx = Math.cos(angle);
                            const ty = Math.sin(angle);
                            const overlap = minDist - dist;
                            
                            // è´¨é‡å¤§çš„æ¨å¼€è´¨é‡å°çš„ (ç®€åŒ–ç‰ˆï¼šæŒ‰æ¯”ä¾‹æ¨)
                            const totalMass = b1.mass + b2.mass;
                            const m1 = b2.mass / totalMass;
                            const m2 = b1.mass / totalMass;

                            b1.x -= tx * overlap * m1;
                            b1.y -= ty * overlap * m1;
                            b2.x += tx * overlap * m2;
                            b2.y += ty * overlap * m2;

                            // 2. é€Ÿåº¦äº¤æ¢ (åŠ¨é‡å®ˆæ’çš„ç®€åŒ–æ¨¡æ‹Ÿ)
                            // å°†é€Ÿåº¦æŠ•å½±åˆ°ç¢°æ’æ³•çº¿ä¸Š
                            const v1 = Math.sqrt(b1.vx*b1.vx + b1.vy*b1.vy);
                            const v2 = Math.sqrt(b2.vx*b2.vx + b2.vy*b2.vy);
                            // ç®€å•çš„èƒ½é‡æŸå¤±ç¢°æ’
                            const force = (v1 + v2) * 0.05; // æŒ¤å‹å¼¹åŠ›
                            b1.vx -= tx * force;
                            b1.vy -= ty * force;
                            b2.vx += tx * force;
                            b2.vy += ty * force;

                            // 3. åˆæˆåˆ¤æ–­
                            if (b1.level === b2.level && b1.level < FRUITS.length - 1) {
                                // åªæœ‰å½“ä¸¤ä¸ªçƒç›¸å¯¹é€Ÿåº¦ä¸å¤§æ—¶æ‰åˆæˆï¼Œæˆ–è€…ä¸ºäº†ç®€å•ï¼Œåªè¦ç¢°äº†å°±åˆæˆ
                                // ä¸ºäº†æ¸¸æˆæ€§ï¼Œç›´æ¥åˆæˆ
                                this.mergeBalls(b1, b2);
                            }
                        }
                    }
                }
            },

            mergeBalls(b1, b2) {
                b1.dead = true;
                b2.dead = true;

                const nextLevel = b1.level + 1;
                const midX = (b1.x + b2.x) / 2;
                const midY = (b1.y + b2.y) / 2;

                // åˆ›å»ºæ–°çƒ
                const newBall = new Ball(midX, midY, nextLevel);
                // ç»™æ–°çƒä¸€ä¸ªå°å°çš„å‘ä¸Šé€Ÿåº¦ï¼Œæ¨¡æ‹Ÿå¼¹èµ·
                newBall.vy = -2; 
                this.balls.push(newBall);

                // åŠ åˆ†
                const score = FRUITS[b1.level].score;
                this.score += score;
                document.getElementById('score-val').innerText = this.score;

                // ç‰¹æ•ˆ
                this.createParticles(midX, midY, FRUITS[b1.level].color);
                
                // éœ‡åŠ¨åé¦ˆ
                if(navigator.vibrate) navigator.vibrate(30);
            },

            createParticles(x, y, color) {
                for(let i=0; i<10; i++) {
                    this.particles.push({
                        x: x, y: y,
                        vx: (Math.random() - 0.5) * 10,
                        vy: (Math.random() - 0.5) * 10,
                        life: 1.0,
                        color: color
                    });
                }
            },

            checkGameOver() {
                // æ£€æŸ¥æ˜¯å¦æœ‰çƒé•¿æ—¶é—´åœç•™åœ¨è­¦æˆ’çº¿ä»¥ä¸Š
                let danger = false;
                for(let b of this.balls) {
                    if (!b.dead && b.y - b.radius < CONFIG.dangerY && b.vy < 0.1 && b.growing >= 1) {
                        danger = true;
                        // å¦‚æœè¶…è¿‡ä¸€å®šé«˜åº¦ï¼Œç›´æ¥ç»“æŸï¼ˆè¿™é‡Œç®€åŒ–ä¸ºç¢°åˆ°çº¿å°±ç®—å±é™©ï¼Œå¦‚æœæŒç»­å¤ªä¹…å°±æŒ‚ï¼‰
                        // å®é™…ç®€åŒ–ï¼šåªè¦é™æ­¢çš„çƒè§¦ç¢°åˆ° Danger Line è¶…è¿‡å‡ å¸§å°±æ­»ï¼Œè¿™é‡Œç”¨é«˜åº¦åˆ¤å®š
                        if (b.y - b.radius < CONFIG.spawnY + 50) {
                            this.gameOver();
                            return;
                        }
                    }
                }
                
                const line = document.getElementById('danger-line');
                line.style.opacity = danger ? 1 : 0;
            },

            gameOver() {
                this.state = 'gameover';
                document.getElementById('final-score').innerText = this.score;
                document.getElementById('game-over-modal').style.display = 'flex';
            },

            loop() {
                ctx.clearRect(0, 0, WIDTH, HEIGHT);

                if (this.state === 'playing') {
                    // 1. æ›´æ–°çƒç‰©ç†
                    for(let b of this.balls) b.update();
                    
                    // 2. ç¢°æ’è§£å†³ (è¿­ä»£å¤šæ¬¡ä»¥å¢åŠ ç¨³å®šæ€§)
                    for(let k=0; k<8; k++) this.checkCollisions();

                    // 3. åˆ¤å®šå¤±è´¥
                    this.checkGameOver();
                }

                // 4. ç»˜åˆ¶
                // ç»˜åˆ¶å¾…å‘½çƒ (åŠé€æ˜)
                if (this.activeBall) {
                    const r = FRUITS[this.activeBall.level].radius * SCALE;
                    ctx.save();
                    ctx.globalAlpha = 0.6;
                    ctx.translate(this.activeBall.x, this.activeBall.y);
                    ctx.beginPath();
                    ctx.arc(0, 0, r, 0, Math.PI * 2);
                    ctx.fillStyle = FRUITS[this.activeBall.level].color;
                    ctx.fill();
                    ctx.font = `${r}px Arial`;
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillText(FRUITS[this.activeBall.level].icon, 0, 5*SCALE);
                    
                    // ç»˜åˆ¶ç„å‡†çº¿
                    ctx.globalAlpha = 0.3;
                    ctx.strokeStyle = '#888';
                    ctx.setLineDash([5, 5]);
                    ctx.beginPath();
                    ctx.moveTo(0, r);
                    ctx.lineTo(0, HEIGHT);
                    ctx.stroke();
                    
                    ctx.restore();
                }

                // ç»˜åˆ¶å®ä½“çƒ
                for (let b of this.balls) {
                    if(!b.dead) b.draw();
                }
                this.balls = this.balls.filter(b => !b.dead);

                // ç»˜åˆ¶ç²’å­
                for (let p of this.particles) {
                    p.x += p.vx; p.y += p.vy;
                    p.life -= 0.05;
                    ctx.globalAlpha = p.life;
                    ctx.fillStyle = p.color;
                    ctx.beginPath();
                    ctx.arc(p.x, p.y, 4, 0, Math.PI*2);
                    ctx.fill();
                }
                this.particles = this.particles.filter(p => p.life > 0);
                ctx.globalAlpha = 1;

                requestAnimationFrame(() => this.loop());
            }
        };

        // å¯åŠ¨
        Game.init();

    </script>
</body>
</html>