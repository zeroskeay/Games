<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å± é¾™å‹‡å£«ï¼šåƒç´ å°„å‡»</title>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #2d3436;
            --ui-text: #dfe6e9;
            --accent: #fab1a0;
        }

        body {
            margin: 0;
            overflow: hidden;
            background-color: var(--bg-color);
            font-family: 'Press Start 2P', cursive; /* åƒç´ å­—ä½“ */
            touch-action: none;
            user-select: none;
        }

        canvas { display: block; }

        /* UI å±‚ */
        #ui-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none;
            display: flex; flex-direction: column; justify-content: space-between;
        }

        /* é¡¶éƒ¨çŠ¶æ€æ  */
        .header {
            padding: 15px;
            display: flex; justify-content: space-between;
            background: linear-gradient(to bottom, rgba(0,0,0,0.8), transparent);
            color: var(--ui-text);
            font-size: 0.8rem;
            text-shadow: 2px 2px 0 #000;
        }

        /* åº•éƒ¨æ“ä½œæç¤º */
        .controls-hint {
            text-align: center; padding-bottom: 30px;
            color: rgba(255,255,255,0.3);
            font-size: 0.7rem;
            animation: blink 2s infinite;
        }

        /* å¼¹çª— */
        #modal {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85);
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            pointer-events: auto;
            z-index: 100;
            backdrop-filter: blur(4px);
        }

        h1 { 
            color: #ff7675; margin-bottom: 20px; font-size: 1.5rem; text-align: center; line-height: 1.5;
            text-shadow: 4px 4px 0 #d63031;
        }

        .btn {
            background: #0984e3; color: white; border: 4px solid #74b9ff;
            padding: 15px 30px; font-family: inherit; font-size: 1rem;
            cursor: pointer; text-transform: uppercase;
            box-shadow: 0 6px 0 #005691;
            margin-top: 20px;
            transition: transform 0.1s;
        }
        .btn:active { transform: translateY(6px); box-shadow: none; }
        
        .btn-home {
            background: #636e72; border-color: #b2bec3; box-shadow: 0 6px 0 #2d3436;
            font-size: 0.7rem; padding: 10px 20px; text-decoration: none; display: inline-block;
        }

        @keyframes blink { 50% { opacity: 0.5; } }

        /* é£˜å­—ç‰¹æ•ˆ */
        .floating-text {
            position: absolute;
            font-weight: bold;
            pointer-events: none;
            animation: floatUp 1s forwards;
            text-shadow: 2px 2px 0 #000;
        }
        @keyframes floatUp {
            0% { transform: translateY(0) scale(1); opacity: 1; }
            100% { transform: translateY(-50px) scale(1.5); opacity: 0; }
        }
    </style>
</head>
<body>

    <canvas id="gameCanvas"></canvas>

    <div id="ui-layer">
        <div class="header">
            <div>SCORE: <span id="scoreVal" style="color:#ffeaa7">0</span></div>
            <div>ğŸ’°: <span id="coinVal">0</span></div>
        </div>
        <div class="controls-hint">
            â—„ å·¦å³æ»‘åŠ¨ç§»åŠ¨ â–º
        </div>
    </div>

    <div id="modal">
        <h1>ğŸ‰ å± é¾™å‹‡å£«<br><span style="font-size:0.8rem; color:#fff;">DRAGON SLAYER</span></h1>
        <div style="text-align:center; color:#aaa; font-size:0.6rem; line-height:1.8; margin-bottom:20px;">
            æ¶ˆç­æ•°å­—æ–¹å—<br>å‡»ç¢å®ç®±è·å–ç¥å™¨
        </div>
        <button class="btn" id="startBtn">START GAME</button>
        <a href="../../index.html" class="btn btn-home">HOME</a>
    </div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        
        // --- âš™ï¸ æ¸¸æˆé…ç½® ---
        const CONFIG = {
            playerSpeed: 1, // è¿™é‡Œçš„é€Ÿåº¦æ˜¯è·Ÿéšæ‰‹æŒ‡çš„ï¼Œç³»æ•°ä¸º1
            bulletSpeed: 12,
            baseFireRate: 10, // å¸§é—´éš”ï¼Œè¶Šå°è¶Šå¿«
            dragonSpeedBase: 0.8, // å·¨é¾™ä¸‹å‹é€Ÿåº¦
            colors: {
                numLow: '#fab1a0', // 1-3
                numMid: '#ff7675', // 4-7
                numHigh: '#d63031', // 8+
                chestCoin: '#ffeaa7',
                chestWep: '#74b9ff',
                chestSkill: '#a29bfe'
            }
        };

        // --- ğŸ”Š éŸ³æ•ˆç³»ç»Ÿ (Synth) ---
        const AudioCtrl = {
            ctx: new (window.AudioContext || window.webkitAudioContext)(),
            play(type) {
                if (this.ctx.state === 'suspended') this.ctx.resume();
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                osc.connect(gain);
                gain.connect(this.ctx.destination);
                const now = this.ctx.currentTime;

                switch(type) {
                    case 'shoot':
                        osc.type = 'square';
                        osc.frequency.setValueAtTime(400, now);
                        osc.frequency.exponentialRampToValueAtTime(100, now + 0.1);
                        gain.gain.setValueAtTime(0.05, now);
                        gain.gain.linearRampToValueAtTime(0, now + 0.1);
                        osc.start(now); osc.stop(now + 0.1);
                        break;
                    case 'hit':
                        osc.type = 'triangle';
                        osc.frequency.setValueAtTime(200, now);
                        gain.gain.setValueAtTime(0.05, now);
                        gain.gain.linearRampToValueAtTime(0, now + 0.05);
                        osc.start(now); osc.stop(now + 0.05);
                        break;
                    case 'break': // æ–¹å—ç ´ç¢
                        osc.type = 'sawtooth';
                        osc.frequency.setValueAtTime(100, now);
                        osc.frequency.exponentialRampToValueAtTime(10, now + 0.2);
                        gain.gain.setValueAtTime(0.1, now);
                        gain.gain.linearRampToValueAtTime(0, now + 0.2);
                        osc.start(now); osc.stop(now + 0.2);
                        break;
                    case 'powerup':
                        osc.type = 'sine';
                        osc.frequency.setValueAtTime(300, now);
                        osc.frequency.linearRampToValueAtTime(800, now + 0.4);
                        gain.gain.setValueAtTime(0.1, now);
                        gain.gain.linearRampToValueAtTime(0, now + 0.4);
                        osc.start(now); osc.stop(now + 0.4);
                        break;
                }
            }
        };

        // --- ğŸ® æ ¸å¿ƒç±» ---

        class Player {
            constructor() {
                this.w = 40; this.h = 40;
                this.x = canvas.width / 2;
                this.y = canvas.height - 80;
                this.color = '#00b894';
                
                // çŠ¶æ€
                this.fireTimer = 0;
                this.weapon = 'normal'; // normal, triple, spread
                this.buffs = {
                    rapid: 0, // æ”»é€ŸåŠ å€å‰©ä½™å¸§æ•°
                    pierce: 0, // ç©¿é€å‰©ä½™å¸§æ•°
                };
            }

            update() {
                // å°„å‡»é€»è¾‘
                let rate = this.buffs.rapid > 0 ? CONFIG.baseFireRate / 2 : CONFIG.baseFireRate;
                this.fireTimer++;
                if (this.fireTimer >= rate) {
                    this.shoot();
                    this.fireTimer = 0;
                }

                // Buff å€’è®¡æ—¶
                if (this.buffs.rapid > 0) this.buffs.rapid--;
                if (this.buffs.pierce > 0) this.buffs.pierce--;
            }

            shoot() {
                AudioCtrl.play('shoot');
                const isPierce = this.buffs.pierce > 0;
                
                if (this.weapon === 'triple') {
                    bullets.push(new Bullet(this.x, this.y, 0, -CONFIG.bulletSpeed, isPierce));
                    bullets.push(new Bullet(this.x - 10, this.y, -1, -CONFIG.bulletSpeed, isPierce));
                    bullets.push(new Bullet(this.x + 10, this.y, 1, -CONFIG.bulletSpeed, isPierce));
                } else if (this.weapon === 'spread') {
                    bullets.push(new Bullet(this.x, this.y, 0, -CONFIG.bulletSpeed, isPierce));
                    bullets.push(new Bullet(this.x, this.y, -3, -CONFIG.bulletSpeed * 0.9, isPierce));
                    bullets.push(new Bullet(this.x, this.y, 3, -CONFIG.bulletSpeed * 0.9, isPierce));
                    bullets.push(new Bullet(this.x, this.y, -6, -CONFIG.bulletSpeed * 0.8, isPierce));
                    bullets.push(new Bullet(this.x, this.y, 6, -CONFIG.bulletSpeed * 0.8, isPierce));
                } else {
                    bullets.push(new Bullet(this.x, this.y, 0, -CONFIG.bulletSpeed, isPierce));
                }
            }

            draw() {
                ctx.fillStyle = this.color;
                // ç®€å•çš„å‹‡å£«åƒç´ ç”»
                ctx.fillRect(this.x - 10, this.y - 10, 20, 20); // èº«ä½“
                ctx.fillStyle = '#ffeaa7'; 
                ctx.fillRect(this.x - 8, this.y - 18, 16, 10); // å¤´
                
                // ç‰¹æ•ˆå…‰ç¯
                if (this.buffs.rapid > 0 || this.buffs.pierce > 0) {
                    ctx.strokeStyle = `rgba(255, 255, 255, ${Math.random()})`;
                    ctx.strokeRect(this.x - 15, this.y - 20, 30, 30);
                }
            }
        }

        class Bullet {
            constructor(x, y, vx, vy, piercing) {
                this.x = x; this.y = y;
                this.vx = vx; this.vy = vy;
                this.r = 4;
                this.active = true;
                this.piercing = piercing;
                this.hitList = []; // ç©¿é€æ¨¡å¼ä¸‹é˜²æ­¢å•å¸§é‡å¤ä¼¤å®³
            }

            update() {
                this.x += this.vx;
                this.y += this.vy;
                if (this.y < 0 || this.x < 0 || this.x > canvas.width) this.active = false;
            }

            draw() {
                ctx.fillStyle = this.piercing ? '#ff0' : '#fff';
                ctx.fillRect(this.x - this.r, this.y - this.r, this.r*2, this.r*2);
            }
        }

        class Block {
            constructor(x, y, w, h, hp, type) {
                this.x = x; this.y = y;
                this.w = w; this.h = h;
                this.hp = hp;
                this.maxHp = hp;
                this.type = type; // num, chest_coin, chest_wep, chest_skill
                this.active = true;
                this.flashTimer = 0;
            }

            update(speed) {
                this.y += speed;
                if (this.flashTimer > 0) this.flashTimer--;
                if (this.y > canvas.height - 100) gameOver();
            }

            takeDamage(amt) {
                this.hp -= amt;
                this.flashTimer = 5;
                AudioCtrl.play('hit');
                if (this.hp <= 0) {
                    this.active = false;
                    this.breakEffect();
                }
            }

            breakEffect() {
                AudioCtrl.play('break');
                // ç²’å­çˆ†ç‚¸
                for(let i=0; i<8; i++) {
                    particles.push(new Particle(this.x + this.w/2, this.y + this.h/2, this.getColor()));
                }

                // å¥–åŠ±é€»è¾‘
                if (this.type === 'num') {
                    Game.score += this.maxHp;
                } else {
                    AudioCtrl.play('powerup');
                    this.triggerReward();
                }
            }

            triggerReward() {
                let txt = "";
                if (this.type === 'chest_coin') {
                    Game.coins += 10;
                    txt = "+10ğŸ’°";
                } else if (this.type === 'chest_wep') {
                    const weps = ['triple', 'spread'];
                    player.weapon = weps[Math.floor(Math.random() * weps.length)];
                    txt = "WEAPON UP!";
                    // æ­¦å™¨æŒç»­10ç§’ï¼Œç„¶åå˜å›æ™®é€š
                    setTimeout(() => { player.weapon = 'normal'; }, 10000);
                } else if (this.type === 'chest_skill') {
                    const skills = ['rapid', 'pierce', 'slow'];
                    const skill = skills[Math.floor(Math.random() * skills.length)];
                    if (skill === 'rapid') {
                        player.buffs.rapid = 300; // 5ç§’ (60fps)
                        txt = "RAPID FIRE!";
                    } else if (skill === 'pierce') {
                        player.buffs.pierce = 300;
                        txt = "PIERCING!";
                    } else if (skill === 'slow') {
                        Game.slowTimer = 300;
                        txt = "TIME SLOW!";
                    }
                }
                showFloatingText(this.x + this.w/2, this.y, txt);
            }

            getColor() {
                if (this.type === 'chest_coin') return CONFIG.colors.chestCoin;
                if (this.type === 'chest_wep') return CONFIG.colors.chestWep;
                if (this.type === 'chest_skill') return CONFIG.colors.chestSkill;
                
                if (this.hp <= 3) return CONFIG.colors.numLow;
                if (this.hp <= 7) return CONFIG.colors.numMid;
                return CONFIG.colors.numHigh;
            }

            draw() {
                // ç»˜åˆ¶æ–¹å—
                if (this.flashTimer > 0) {
                    ctx.fillStyle = '#fff';
                } else {
                    ctx.fillStyle = this.getColor();
                }
                
                // åƒç´ é£æè¾¹
                ctx.fillRect(this.x, this.y, this.w, this.h);
                ctx.lineWidth = 4;
                ctx.strokeStyle = 'rgba(0,0,0,0.2)';
                ctx.strokeRect(this.x, this.y, this.w, this.h);
                
                // é˜´å½±æ•ˆæœ (ç«‹ä½“æ„Ÿ)
                ctx.fillStyle = 'rgba(0,0,0,0.1)';
                ctx.fillRect(this.x + 4, this.y + this.h - 8, this.w - 8, 4);

                // å†…å®¹ç»˜åˆ¶
                ctx.fillStyle = '#fff';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                
                const cx = this.x + this.w/2;
                const cy = this.y + this.h/2;

                if (this.type === 'num') {
                    ctx.font = '20px "Press Start 2P"';
                    ctx.fillText(this.hp, cx, cy);
                } else {
                    ctx.font = '24px sans-serif';
                    let icon = 'â“';
                    if (this.type === 'chest_coin') icon = 'ğŸ’°';
                    if (this.type === 'chest_wep') icon = 'ğŸ”«';
                    if (this.type === 'chest_skill') icon = 'âœ¨';
                    ctx.fillText(icon, cx, cy);
                }
            }
        }

        class Particle {
            constructor(x, y, color) {
                this.x = x; this.y = y; this.color = color;
                this.vx = (Math.random() - 0.5) * 10;
                this.vy = (Math.random() - 0.5) * 10;
                this.life = 1.0;
                this.size = Math.random() * 6 + 4;
            }
            update() {
                this.x += this.vx; this.y += this.vy;
                this.life -= 0.05;
                this.size *= 0.9;
            }
            draw() {
                ctx.globalAlpha = this.life;
                ctx.fillStyle = this.color;
                ctx.fillRect(this.x, this.y, this.size, this.size);
                ctx.globalAlpha = 1.0;
            }
        }

        // --- ğŸ•¹ï¸ æ¸¸æˆä¸»é€»è¾‘ ---
        
        const Game = {
            running: false,
            score: 0,
            coins: 0,
            level: 1,
            frames: 0,
            slowTimer: 0,
            
            start() {
                this.running = true;
                this.score = 0;
                this.coins = 0;
                this.level = 1;
                this.frames = 0;
                
                player = new Player();
                bullets = [];
                blocks = [];
                particles = [];
                
                document.getElementById('modal').style.display = 'none';
                updateUI();
                
                // åˆå§‹ç”Ÿæˆä¸€è¡Œ
                spawnRow();
                loop();
            }
        };

        let player;
        let bullets = [];
        let blocks = [];
        let particles = [];

        // å±å¹•é€‚é…
        function resize() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            if(player) {
                player.y = canvas.height - 80;
                player.x = canvas.width / 2;
            }
        }
        window.addEventListener('resize', resize);
        resize();

        function spawnRow() {
            const cols = 5;
            const w = canvas.width / cols;
            const h = w; // æ­£æ–¹å½¢

            // ç”Ÿæˆä¸€è¡Œæ–¹å—
            for (let i = 0; i < cols; i++) {
                // ç•™ç©ºéš™ï¼Œä¸æ˜¯å¡«æ»¡
                if (Math.random() > 0.7) continue;

                let type = 'num';
                let hp = Math.floor(Math.random() *