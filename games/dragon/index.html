<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ³¡æ³¡é¾™å¤§ä½œæˆ˜</title>
    <style>
        :root {
            --bg-color: #E0F7FA;
            --primary: #4DD0E1;
            --accent: #FF8A65;
            --text: #006064;
        }

        body {
            margin: 0;
            overflow: hidden;
            background-color: var(--bg-color);
            font-family: 'Segoe UI', 'Comic Sans MS', sans-serif;
            touch-action: none; /* ç¦æ­¢æµè§ˆå™¨é»˜è®¤æ»šåŠ¨ */
            user-select: none;
        }

        /* æ¸¸æˆç”»å¸ƒå…¨å± */
        canvas {
            display: block;
            width: 100%;
            height: 100%;
        }

        /* UI å±‚ */
        #ui-layer {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; /* è®©ç‚¹å‡»ç©¿é€åˆ° Canvas */
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: 20px;
            box-sizing: border-box;
        }

        .score-board {
            font-size: 1.5rem;
            font-weight: 900;
            color: var(--text);
            text-shadow: 2px 2px 0px white;
        }

        /* å¼€å§‹/ç»“æŸ å¼¹çª— */
        #modal {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.8);
            backdrop-filter: blur(5px);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            pointer-events: auto;
            z-index: 100;
        }

        h1 { margin: 0 0 10px 0; color: #FF7043; font-size: 2.5rem; text-shadow: 3px 3px 0 #FFCCBC; }
        p { color: #555; font-size: 1.1rem; margin-bottom: 30px; text-align: center; padding: 0 20px; }

        .btn {
            background: #26C6DA;
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 1.5rem;
            border-radius: 50px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 5px 0 #0097A7;
            transition: transform 0.1s;
            text-decoration: none;
        }
        .btn:active { transform: translateY(5px); box-shadow: none; }

        .btn-home {
            margin-top: 20px;
            background: #fff;
            color: #888;
            font-size: 1rem;
            padding: 10px 20px;
            box-shadow: 0 3px 0 #ccc;
        }
    </style>
</head>
<body>

    <canvas id="gameCanvas"></canvas>

    <div id="ui-layer">
        <div class="score-board">ğŸ’ <span id="scoreVal">0</span></div>
    </div>

    <div id="modal">
        <h1>ğŸ² æ³¡æ³¡é¾™å¤§ä½œæˆ˜</h1>
        <p id="modal-msg">æ‹–åŠ¨é£æœºå°„å‡»æ•°å­—ï¼Œ<br>åƒä¸‡åˆ«è®©é¾™æ’åˆ°ä½ ï¼</p>
        <button class="btn" id="startBtn">å¼€å§‹æˆ˜æ–—</button>
        <a href="../../index.html" class="btn btn btn-home">ğŸ  è¿”å›å¤§å…</a>
    </div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const startBtn = document.getElementById('startBtn');
        const modal = document.getElementById('modal');
        const modalMsg = document.getElementById('modal-msg');
        const scoreEl = document.getElementById('scoreVal');

        // --- ğŸ“± é€‚é…å±å¹• ---
        let WIDTH, HEIGHT;
        function resize() {
            WIDTH = window.innerWidth;
            HEIGHT = window.innerHeight;
            canvas.width = WIDTH * window.devicePixelRatio;
            canvas.height = HEIGHT * window.devicePixelRatio;
            ctx.scale(window.devicePixelRatio, window.devicePixelRatio);
        }
        window.addEventListener('resize', resize);
        resize();

        // --- ğŸ”Š éŸ³æ•ˆ (Web Audio API) ---
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playSound(type) {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            const now = audioCtx.currentTime;

            if (type === 'shoot') {
                // æçŸ­çš„å°„å‡»å£°
                osc.type = 'triangle';
                osc.frequency.setValueAtTime(800, now);
                osc.frequency.exponentialRampToValueAtTime(100, now + 0.1);
                gain.gain.setValueAtTime(0.05, now);
                gain.gain.linearRampToValueAtTime(0, now + 0.1);
                osc.start(now);
                osc.stop(now + 0.1);
            } else if (type === 'hit') {
                // å‡»ä¸­åé¦ˆ
                osc.type = 'square';
                osc.frequency.setValueAtTime(200, now);
                gain.gain.setValueAtTime(0.05, now);
                gain.gain.linearRampToValueAtTime(0, now + 0.05);
                osc.start(now);
                osc.stop(now + 0.05);
            } else if (type === 'explode') {
                // çˆ†ç‚¸
                osc.type = 'sawtooth';
                osc.frequency.setValueAtTime(100, now);
                osc.frequency.exponentialRampToValueAtTime(10, now + 0.3);
                gain.gain.setValueAtTime(0.1, now);
                gain.gain.linearRampToValueAtTime(0, now + 0.3);
                osc.start(now);
                osc.stop(now + 0.3);
            } else if (type === 'powerup') {
                // å‡çº§
                osc.type = 'sine';
                osc.frequency.setValueAtTime(400, now);
                osc.frequency.linearRampToValueAtTime(1200, now + 0.3);
                gain.gain.setValueAtTime(0.1, now);
                gain.gain.linearRampToValueAtTime(0, now + 0.3);
                osc.start(now);
                osc.stop(now + 0.3);
            }
        }

        // --- ğŸ® æ¸¸æˆå¯¹è±¡ç±» ---
        
        // 1. ç©å®¶é£æœº
        const player = {
            x: 0, y: 0, r: 25,
            power: 1, // å­å¼¹ä¼¤å®³
            fireLevel: 1, // å°„é€Ÿ/å­å¼¹æ•°ç­‰çº§
            lastFire: 0,
            color: '#FF7043',
            emoji: 'ğŸš€'
        };

        // 2. å­å¼¹
        let bullets = [];
        class Bullet {
            constructor(x, y, vx, vy) {
                this.x = x; this.y = y;
                this.vx = vx; this.vy = vy;
                this.r = 6;
                this.active = true;
            }
            update() {
                this.x += this.vx;
                this.y += this.vy;
                if (this.y < -10 || this.x < 0 || this.x > WIDTH) this.active = false;
            }
            draw() {
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.r, 0, Math.PI*2);
                ctx.fillStyle = '#FFD54F';
                ctx.fill();
            }
        }

        // 3. é¾™ (ç”±å¤šä¸ªæ®µç»„æˆ)
        let dragons = []; // å­˜å‚¨å¤šæ¡é¾™
        class DragonSegment {
            constructor(x, y, hp, type, isHead) {
                this.x = x; this.y = y;
                this.r = isHead ? 35 : 28; // é¾™å¤´å¤§ä¸€ç‚¹
                this.hp = hp;
                this.maxHp = hp;
                this.type = type; // 'body' or 'chest'
                this.isHead = isHead;
                this.active = true;
                this.color = `hsl(${Math.random() * 360}, 70%, 70%)`;
                this.offset = Math.random() * 100; // ç”¨äºæ‘†åŠ¨åŠ¨ç”»
            }

            update(speed, time) {
                // è›‡å½¢èµ°ä½ï¼šXè½´åŸºäºæ­£å¼¦æ³¢æ‘†åŠ¨
                this.y += speed;
                this.x += Math.sin(time * 0.005 + this.offset) * 1.5; 
                
                // è¾¹ç•Œå¤„ç†
                if (this.x < this.r) this.x = this.r;
                if (this.x > WIDTH - this.r) this.x = WIDTH - this.r;
            }

            draw() {
                // ç»˜åˆ¶åœ†çƒ
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.r, 0, Math.PI*2);
                
                if (this.type === 'chest') {
                    ctx.fillStyle = '#FFD700'; // é‡‘è‰²å®ç®±
                    ctx.shadowBlur = 15;
                    ctx.shadowColor = 'yellow';
                } else {
                    ctx.fillStyle = this.color;
                    ctx.shadowBlur = 0;
                }
                ctx.fill();
                ctx.shadowBlur = 0;

                // ç»˜åˆ¶å†…éƒ¨ (è¡¨æƒ…æˆ–æ•°å­—)
                ctx.fillStyle = '#fff';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                
                if (this.isHead) {
                    ctx.font = '40px Arial';
                    ctx.fillText('ğŸ²', this.x, this.y + 5);
                } else if (this.type === 'chest') {
                    ctx.font = '30px Arial';
                    ctx.fillText('ğŸ', this.x, this.y + 3);
                } else {
                    ctx.font = 'bold 20px Arial';
                    ctx.fillText(this.hp, this.x, this.y);
                    
                    // ç»˜åˆ¶è¡€æ¡åœˆ
                    ctx.beginPath();
                    ctx.arc(this.x, this.y, this.r - 2, -Math.PI/2, -Math.PI/2 + (Math.PI*2 * (this.hp/this.maxHp)));
                    ctx.strokeStyle = 'rgba(255,255,255,0.5)';
                    ctx.lineWidth = 4;
                    ctx.stroke();
                }
            }
        }

        // 4. ç²’å­æ•ˆæœ (çˆ†ç‚¸)
        let particles = [];
        class Particle {
            constructor(x, y, color) {
                this.x = x; this.y = y;
                const angle = Math.random() * Math.PI * 2;
                const speed = Math.random() * 5 + 2;
                this.vx = Math.cos(angle) * speed;
                this.vy = Math.sin(angle) * speed;
                this.life = 1.0;
                this.color = color;
            }
            update() {
                this.x += this.vx;
                this.y += this.vy;
                this.life -= 0.05;
                this.vy += 0.2; // é‡åŠ›
            }
            draw() {
                ctx.globalAlpha = this.life;
                ctx.fillStyle = this.color;
                ctx.beginPath();
                ctx.arc(this.x, this.y, 4, 0, Math.PI*2);
                ctx.fill();
                ctx.globalAlpha = 1.0;
            }
        }

        // --- ğŸ•¹ï¸ æ¸¸æˆæ ¸å¿ƒé€»è¾‘ ---
        let gameRunning = false;
        let score = 0;
        let frames = 0;
        let spawnRate = 200; // åˆå§‹ç”Ÿæˆé¢‘ç‡
        let gameSpeed = 1.5;
        let difficulty = 1;

        function init() {
            player.x = WIDTH / 2;
            player.y = HEIGHT - 100;
            player.power = 1;
            player.fireLevel = 1;
            
            bullets = [];
            dragons = []; // è¿™é‡Œdragonsæ˜¯ä¸€ä¸ªäºŒç»´æ•°ç»„ï¼Œæ¯ä¸ªå…ƒç´ æ˜¯ä¸€æ¡é¾™(æ•°ç»„)
            particles = [];
            score = 0;
            scoreEl.innerText = 0;
            difficulty = 1;
            gameSpeed = 1.5;
            frames = 0;
        }

        function spawnDragon() {
            // å†³å®šè¿™æ¡é¾™å¤šé•¿
            const length = Math.floor(Math.random() * 4) + 3 + Math.floor(difficulty/2);
            const startX = Math.random() * (WIDTH - 60) + 30;
            let newDragon = [];

            // ç”Ÿæˆé¾™å¤´
            newDragon.push(new DragonSegment(startX, -50, 999, 'body', true));

            // ç”Ÿæˆé¾™èº«
            for(let i=1; i<length; i++) {
                // æœ‰æ¦‚ç‡ç”Ÿæˆå®ç®±
                const isChest = Math.random() < 0.1;
                const hp = isChest ? 10 : Math.floor(Math.random() * 5 * difficulty) + 2;
                const type = isChest ? 'chest' : 'body';
                // Yè½´å‘ä¸Šæ’åˆ—ï¼Œè®©å®ƒä»¬æ…¢æ…¢è½ä¸‹æ¥
                newDragon.push(new DragonSegment(startX, -50 - (i*55), hp, type, false));
            }
            dragons.push(newDragon);
        }

        function update() {
            if (!gameRunning) return;

            // 1. ç”Ÿæˆæ§åˆ¶
            frames++;
            if (frames % 250 === 0) {
                spawnDragon();
                difficulty += 0.5; // éš¾åº¦éšæ—¶é—´å¢åŠ 
                if(difficulty > 10) gameSpeed += 0.05; // é€Ÿåº¦ä¹Ÿå¢åŠ 
            }

            // 2. ç©å®¶è‡ªåŠ¨å°„å‡»
            const fireRate = Math.max(5, 20 - player.fireLevel * 2); // ç­‰çº§è¶Šé«˜å°„é€Ÿè¶Šå¿«
            if (frames % fireRate === 0) {
                playSound('shoot');
                // æ ¹æ®ç­‰çº§å‘å°„ä¸åŒæ•°é‡çš„å­å¼¹
                bullets.push(new Bullet(player.x, player.y - 20, 0, -12)); // ä¸»ç‚®
                
                if (player.fireLevel >= 2) {
                    bullets.push(new Bullet(player.x - 15, player.y - 10, -2, -10));
                    bullets.push(new Bullet(player.x + 15, player.y - 10, 2, -10));
                }
                if (player.fireLevel >= 5) {
                     bullets.push(new Bullet(player.x - 30, player.y, -4, -9));
                     bullets.push(new Bullet(player.x + 30, player.y, 4, -9));
                }
            }

            // 3. æ›´æ–°å­å¼¹
            bullets.forEach(b => b.update());
            bullets = bullets.filter(b => b.active);

            // 4. æ›´æ–°é¾™
            for (let dIndex = dragons.length - 1; dIndex >= 0; dIndex--) {
                let dragon = dragons[dIndex];
                let dragonSpeed = gameSpeed + (difficulty * 0.1);

                for (let sIndex = dragon.length - 1; sIndex >= 0; sIndex--) {
                    let seg = dragon[sIndex];
                    seg.update(dragonSpeed, frames);

                    // ç¢°æ’æ£€æµ‹ï¼šé¾™æ’ç©å®¶ -> Game Over
                    const distToPlayer = Math.hypot(seg.x - player.x, seg.y - player.y);
                    if (distToPlayer < seg.r + player.r) {
                        gameOver();
                        return;
                    }

                    // ç¢°æ’æ£€æµ‹ï¼šå­å¼¹æ’é¾™æ®µ
                    for (let b of bullets) {
                        if (!b.active || !seg.active) continue;
                        const dist = Math.hypot(b.x - seg.x, b.y - seg.y);
                        if (dist < seg.r + b.r) {
                            b.active = false; // å­å¼¹æ¶ˆå¤±
                            playSound('hit');
                            
                            // å®ç®±ç‰¹æ®Šå¤„ç†
                            if (seg.type === 'chest') {
                                seg.hp -= player.power * 2; // å®ç®±å®¹æ˜“æ‰“
                            } else if (!seg.isHead) {
                                seg.hp -= player.power;
                            }

                            // çˆ†ç‚¸é€»è¾‘
                            if (seg.hp <= 0 && !seg.isHead) {
                                seg.active = false;
                                createExplosion(seg.x, seg.y, seg.color);
                                score += 10;
                                scoreEl.innerText = score;

                                if (seg.type === 'chest') {
                                    playSound('powerup');
                                    player.fireLevel = Math.min(player.fireLevel + 1, 6);
                                    player.power += 1;
                                    createFloatingText(seg.x, seg.y, "UPGRADE!");
                                } else {
                                    playSound('explode');
                                }
                            }
                        }
                    }

                    // ç§»é™¤å±å¹•åº•éƒ¨çš„é¾™
                    if (seg.y > HEIGHT + 50) seg.active = false;
                }

                // æ¸…ç†å·²æ­»æ‰çš„æ®µ
                dragons[dIndex] = dragon.filter(s => s.active);
                
                // å¦‚æœé¾™åªå‰©ä¸‹å¤´ï¼Œæˆ–è€…ç©ºäº†ï¼Œæ•´æ¡é¾™ç§»é™¤ï¼ˆå¤´æ˜¯æ— æ•Œçš„ï¼Œé™¤éèº«å­å…¨æ²¡äº†ï¼Œè¿™é‡Œç®€åŒ–ï¼šå¤´ä¸æŒ¡å­å¼¹ï¼Œåªåšè£…é¥°å’Œç¢°æ’åˆ¤å®šï¼‰
                // ä¿®æ­£ï¼šå¤´ä¸åº”è¯¥èƒ½è¢«æ‰“çˆ†ï¼Œä½†å¦‚æœèº«å­å…¨æ²¡äº†ï¼Œå¤´å°±é£èµ°æˆ–æ¶ˆå¤±ï¼Ÿ
                // ç®€åŒ–é€»è¾‘ï¼šå¤´ä¹Ÿæ˜¯ä¸€æ®µï¼Œä½†è¡€é‡æ— é™ï¼Œåªæœ‰æ’å‡»åˆ¤å®šã€‚èº«å­å…¨æ²¡äº†ï¼Œå¤´ç»§ç»­é£å‡ºå±å¹•ã€‚
                if (dragons[dIndex].length === 0) {
                    dragons.splice(dIndex, 1);
                }
            }

            // 5. æ›´æ–°ç²’å­
            particles.forEach(p => p.update());
            particles = particles.filter(p => p.life > 0);
        }

        function draw() {
            // æ¸…å±
            ctx.clearRect(0, 0, WIDTH, HEIGHT);

            // 1. ç”»é¾™
            dragons.forEach(dragon => {
                // è¿çº¿
                if (dragon.length > 1) {
                    ctx.beginPath();
                    ctx.moveTo(dragon[0].x, dragon[0].y);
                    for(let i=1; i<dragon.length; i++) {
                        ctx.lineTo(dragon[i].x, dragon[i].y);
                    }
                    ctx.strokeStyle = 'rgba(0,0,0,0.1)';
                    ctx.lineWidth = 10;
                    ctx.stroke();
                }
                // ç”»çƒ
                dragon.forEach(seg => seg.draw());
            });

            // 2. ç”»å­å¼¹
            bullets.forEach(b => b.draw());

            // 3. ç”»ç©å®¶
            ctx.fillStyle = player.color;
            ctx.font = '50px Arial';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(player.emoji, player.x, player.y);
            
            // 4. ç”»ç²’å­
            particles.forEach(p => p.draw());

            if (gameRunning) requestAnimationFrame(loop);
        }

        function loop() {
            update();
            draw();
        }

        function createExplosion(x, y, color) {
            for(let i=0; i<10; i++) {
                particles.push(new Particle(x, y, color));
            }
        }
        
        function createFloatingText(x, y, text) {
            // ç®€å•å®ç°ï¼šç”¨Canvasç”»ä¸€ä¸‹ï¼Œæˆ–è€…DOMã€‚è¿™é‡Œæš‚ç•¥ï¼Œç›´æ¥ç²’å­æ•ˆæœå¤Ÿäº†
        }

        function gameOver() {
            gameRunning = false;
            modal.style.display = 'flex';
            modalMsg.innerHTML = `ğŸ’¥ æ¸¸æˆç»“æŸï¼<br>ä½ çš„å¾—åˆ†: ${score}`;
            startBtn.innerText = "é‡æ–°æŒ‘æˆ˜";
        }

        // --- ğŸ•¹ï¸ äº¤äº’äº‹ä»¶ ---
        
        // è§¦æ‘¸/é¼ æ ‡ æ‹–åŠ¨æ§åˆ¶
        function movePlayer(clientX) {
            // é™åˆ¶åœ¨å±å¹•å†…
            player.x = clientX * window.devicePixelRatio; 
            if (player.x < 30) player.x = 30;
            if (player.x > WIDTH - 30) player.x = WIDTH - 30;
        }

        canvas.addEventListener('touchmove', (e) => {
            e.preventDefault(); // é˜»æ­¢æ»šåŠ¨
            movePlayer(e.touches[0].clientX);
        }, {passive: false});

        canvas.addEventListener('mousemove', (e) => {
            if (gameRunning) movePlayer(e.clientX);
        });

        startBtn.addEventListener('click', () => {
            modal.style.display = 'none';
            if (!gameRunning) {
                init();
                gameRunning = true;
                // é¢„å…ˆç”Ÿæˆä¸€æ¡é¾™
                spawnDragon();
                loop();
            }
        });

    </script>
</body>
</html>